<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Instagram Analyzer</title>
  <link rel="stylesheet" href="/static/style.css?v={{ static_version }}">
</head>
<body class="page-index">

<div id="overlay">
  <div class="spinner"></div>
  <div class="progress-text" id="progress-title">Analyzing data...</div>
  <div class="progress-bar-wrap">
    <div class="progress-bar-fill" id="progress-fill"></div>
  </div>
  <div class="progress-count" id="progress-count"></div>
  <div class="progress-sub" id="progress-sub">Building your report from the exportâ€¦</div>
</div>

<div class="card">
  <div class="logo">
    <svg viewBox="0 0 24 24">
      <rect x="2" y="2" width="20" height="20" rx="5" ry="5"/>
      <circle cx="12" cy="12" r="4"/>
      <circle cx="17.5" cy="6.5" r="1" fill="#fff" stroke="none"/>
    </svg>
  </div>
  <h1>Instagram Analyzer</h1>
  <p class="subtitle">Get a report of who's not following you back</p>

  <div class="home-steps">
    <div class="home-step home-step-1">
      <span class="home-step-num">1</span>
      <div class="home-step-body">
        <h2 class="home-step-title">Step 1: Get the ZIP file from Instagram</h2>
        <p class="home-step-desc">Not sure how? <a href="/guide">Click here for the guide</a></p>
      </div>
    </div>

    <div class="home-step home-step-2">
      <span class="home-step-num">2</span>
      <div class="home-step-body">
        <h2 class="home-step-title">Step 2: Upload the ZIP file</h2>
        <form id="upload-form" action="/analyze" method="post" enctype="multipart/form-data">
          <div class="drop-zone" id="drop-zone">
            <input type="file" name="zipfile" id="file-input" accept=".zip">
            <div class="drop-icon">ðŸ“¦</div>
            <div class="drop-text">Drag a ZIP file here</div>
            <div class="drop-hint">or click to browse</div>
          </div>
          <div class="file-chosen" id="file-chosen"></div>
          <div class="file-error" id="file-error" role="alert" aria-live="polite"></div>
          <button type="submit" class="btn" id="submit-btn" disabled>Analyze â†’</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const input     = document.getElementById('file-input');
  const chosen    = document.getElementById('file-chosen');
  const fileError = document.getElementById('file-error');
  const btn       = document.getElementById('submit-btn');
  const drop      = document.getElementById('drop-zone');
  const form      = document.getElementById('upload-form');
  const overlay   = document.getElementById('overlay');
  const fill      = document.getElementById('progress-fill');
  const count     = document.getElementById('progress-count');
  const title     = document.getElementById('progress-title');
  const subtext   = document.getElementById('progress-sub');

  const MAX_FILE_SIZE = 5 * 1024 * 1024;

  function setError(msg, reasons) {
    if (!msg && !(reasons && reasons.length)) {
      fileError.innerHTML = '';
      fileError.style.display = 'none';
      fileError.classList.remove('file-error--list');
      return;
    }
    fileError.style.display = 'block';
    if (reasons && reasons.length) {
      fileError.classList.add('file-error--list');
      const tip = reasons.filter(r => r.startsWith('â†’'));
      const points = reasons.filter(r => !r.startsWith('â†’'));
      fileError.innerHTML =
        '<span class="file-error-title">File doesn\'t match required format</span>' +
        '<ul class="file-error-list">' + points.map(p => '<li>' + escapeHtml(p) + '</li>').join('') + '</ul>' +
        (tip.length ? '<p class="file-error-tip">' + escapeHtml(tip[0]) + ' <a href="/guide">Full guide</a></p>' : '');
    } else {
      fileError.classList.remove('file-error--list');
      fileError.textContent = msg || '';
    }
  }
  function escapeHtml(s) {
    const div = document.createElement('div');
    div.textContent = s;
    return div.innerHTML;
  }

  function validateFile(file) {
    setError('');
    if (!file) return false;
    if (!file.name.toLowerCase().endsWith('.zip')) {
      setError('Please choose a .zip file only.');
      return false;
    }
    if (file.size > MAX_FILE_SIZE) {
      setError('File is too large (max 5 MB). Request a smaller date range in Instagram.');
      return false;
    }
    return true;
  }

  function setFileState(file) {
    if (!file) { chosen.textContent = ''; setError(''); btn.disabled = true; return; }
    chosen.textContent = 'ðŸ“Ž ' + file.name;
    if (validateFile(file)) { setError(''); btn.disabled = false; }
    else btn.disabled = true;
  }

  input.addEventListener('change', () => setFileState(input.files[0]));

  drop.addEventListener('dragover',  e => { e.preventDefault(); drop.classList.add('drag-over'); });
  drop.addEventListener('dragleave', ()  => drop.classList.remove('drag-over'));
  drop.addEventListener('drop', e => {
    e.preventDefault(); drop.classList.remove('drag-over');
    if (e.dataTransfer.files[0]) {
      input.files = e.dataTransfer.files;
      setFileState(input.files[0]);
    }
  });

  form.addEventListener('submit', e => {
    e.preventDefault();
    const file = input.files[0];
    if (!file) return;
    if (!validateFile(file)) return;

    setError('');
    overlay.classList.add('visible');
    title.textContent = 'Analyzing data...';
    subtext.textContent = '';

    const poll = setInterval(async () => {
      try {
        const r = await fetch('/progress');
        const d = await r.json();
        if (d.total > 0) {
          fill.style.width = Math.round(d.done / d.total * 100) + '%';
          count.textContent = Math.round(d.done / d.total * 100) + '%';
          title.textContent = d.phase || 'Analyzing data...';
          subtext.textContent = '';
        }
      } catch {}
    }, 600);

    fetch('/analyze', { method: 'POST', body: new FormData(form) })
      .then(async r => {
        clearInterval(poll);
        if (r.ok) {
          const html = await r.text();
          document.open(); document.write(html); document.close();
          return;
        }
        overlay.classList.remove('visible');
        let msg = 'Upload or analysis failed.';
        if (r.status === 413) msg = 'File is too large. Request a smaller date range in Instagram.';
        else if (r.status === 400) {
          try {
            const d = await r.json();
            if (d.reasons && d.reasons.length) {
              setError(null, d.reasons);
              return;
            }
          } catch {}
        }
        setError(msg);
      })
      .catch(() => {
        clearInterval(poll);
        overlay.classList.remove('visible');
        setError('Network error. Please try again.');
      });
  });
</script>
</body>
</html>
